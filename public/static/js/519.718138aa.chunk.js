"use strict";(self.webpackChunkclient=self.webpackChunkclient||[]).push([[519],{519:(e,t,l)=>{l.r(t),l.d(t,{default:()=>s});var n=l(43),r=l(674),a=l(912),i=l(579);function s(){var e;const t=localStorage.getItem("token"),s=(()=>{try{const e=null===t||void 0===t?void 0:t.split(".")[1];if(!e)return null;const l=JSON.parse(atob(e.replace(/-/g,"+").replace(/_/g,"/")));return l.id||l.userId||l._id||null}catch(e){return null}})(),[o,d]=(0,n.useState)([]),[c,u]=(0,n.useState)("global"),[p,h]=(0,n.useState)([]),[v,g]=(0,n.useState)(""),[m,f]=(0,n.useState)(""),[x,y]=(0,n.useState)(""),b=(0,n.useRef)(null),j=(0,n.useRef)(null),w=(0,n.useRef)({}),[S,k]=(0,n.useState)([]),A=(0,n.useCallback)(async()=>{try{const{data:e}=await r.A.get("/chat/rooms");d(e)}catch(e){f("Erreur chargement salles")}},[]),R=(0,n.useCallback)(async e=>{try{const{data:t}=await r.A.get("/chat/rooms/".concat(e,"/messages"));h(t)}catch(t){h([])}},[]);(0,n.useEffect)(()=>{if(!t)return;let e;A();let n=!1;return(async()=>{try{var a,i;const s=((null===r.A||void 0===r.A||null===(a=r.A.defaults)||void 0===a||null===(i=a.baseURL)||void 0===i?void 0:i.replace(/\/$/,""))||"").replace(/^http/,"ws")+"/chat",{io:o}=await l.e(104).then(l.bind(l,104));if(n)return;e=o(s,{auth:{token:t}}),b.current=e,e.on("connected",()=>f("Connect\xe9")),e.on("message",e=>{h(t=>t.concat(e))}),e.on("error_msg",e=>f(e)),e.on("messageDeleted",e=>{let{id:t}=e;h(e=>e.filter(e=>e.id!==t))}),e.on("joined",e=>{let{roomId:t}=e;t===c&&R(t)}),e.on("typing",e=>{let{user:t,typing:l}=e;w.current[t]=l?Date.now():0;const n=Object.entries(w.current).filter(e=>{let[,t]=e;return t&&Date.now()-t<4e3}).map(e=>{let[t]=e;return t});k(n)})}catch(s){f("Connexion temps r\xe9el indisponible")}})(),()=>{n=!0,e&&e.disconnect()}},[t,A,R,c]),(0,n.useEffect)(()=>{var e;null===(e=j.current)||void 0===e||e.scrollIntoView({behavior:"smooth"})},[p]),(0,n.useEffect)(()=>{c&&R(c)},[c,R]);const C=e=>{var t;e.preventDefault(),(v.trim()||x)&&(null===(t=b.current)||void 0===t||t.emit("message",{roomId:c,content:v,imageUrl:x}),g(""),y(""))};return(0,i.jsxs)("div",{style:{display:"flex",height:"85vh",gap:16},children:[(0,i.jsxs)("aside",{style:{width:280,borderRight:"1px solid var(--line)",display:"flex",flexDirection:"column"},children:[(0,i.jsx)("div",{style:{padding:8,fontWeight:"bold"},children:"Salles"}),(0,i.jsx)("div",{style:{flex:1,overflowY:"auto"},children:o.map(e=>(0,i.jsx)("div",{onClick:()=>u(e.id),style:{cursor:"pointer",padding:"6px 10px",background:c===e.id?"var(--accent-soft)":"transparent"},children:e.name},e.id))}),(0,i.jsx)("button",{onClick:async()=>{const e=prompt("Nom du groupe ?");if(e)try{const{data:t}=await r.A.post("/chat/rooms",{name:e});d(e=>e.concat(t)),u(t.id)}catch(t){f("Erreur cr\xe9ation salle")}},style:{margin:8},children:"+ Groupe"})]}),(0,i.jsxs)("main",{style:{flex:1,display:"flex",flexDirection:"column"},children:[(0,i.jsxs)("div",{style:{padding:"4px 8px",borderBottom:"1px solid var(--line)",display:"flex",justifyContent:"space-between"},children:[(0,i.jsx)("strong",{children:(null===(e=o.find(e=>e.id===c))||void 0===e?void 0:e.name)||"G\xe9n\xe9ral"}),(0,i.jsx)("span",{style:{fontSize:12,color:"var(--muted)"},children:m})]}),(0,i.jsxs)("div",{style:{flex:1,overflowY:"auto",padding:12,background:"var(--panel)"},children:[p.map(e=>{const t=new Date(e.createdAt),l=String(t.getHours()).padStart(2,"0"),n=String(t.getMinutes()).padStart(2,"0");return(0,i.jsxs)("div",{style:{marginBottom:6,display:"flex",gap:8},children:[(0,i.jsxs)("span",{style:{color:"var(--muted)",fontSize:11,marginRight:4},children:["[",l,":",n,"]"]}),(0,i.jsxs)("span",{style:{fontWeight:"bold"},children:[e.username,": "]}),(0,i.jsxs)("div",{style:{flex:1},children:[(0,i.jsx)("span",{style:{whiteSpace:"pre-wrap"},children:e.content}),e.imageUrl&&(0,i.jsx)("div",{children:(0,i.jsx)("img",{loading:"lazy",src:e.imageUrl.startsWith("/")?r.A.defaults.baseURL.replace(/\/$/,"")+e.imageUrl:e.imageUrl,alt:"img",style:{maxWidth:360,borderRadius:8,marginTop:6}})})]}),e.user===s&&(0,i.jsx)("button",{className:"week-btn",title:"Supprimer",onClick:async()=>{try{await r.A.delete("/chat/messages/".concat(e.id)),h(t=>t.filter(t=>t.id!==e.id))}catch(t){f("Suppression impossible")}},children:"\ud83d\uddd1\ufe0f"})]},e.id)}),(0,i.jsx)("div",{ref:j})]}),S.length>0&&(0,i.jsxs)("div",{style:{padding:"2px 10px",fontSize:12,color:"var(--muted)"},children:[S.join(", ")," \xe9crit..."]}),(0,i.jsxs)("form",{onSubmit:C,style:{display:"flex",gap:12,padding:12,alignItems:"flex-start"},children:[(0,i.jsx)("textarea",{value:v,onChange:e=>{var t;g(e.target.value),null===(t=b.current)||void 0===t||t.emit("typing",{roomId:c,typing:!0})},onKeyDown:e=>{"Enter"!==e.key||e.shiftKey||C(e)},placeholder:"Message (Entr\xe9e pour envoyer, Shift+Entr\xe9e pour nouvelle ligne)",style:{flex:1,resize:"none",minHeight:80}}),(0,i.jsxs)("div",{style:{display:"flex",flexDirection:"column",gap:8,width:360,flexShrink:0},children:[(0,i.jsx)(a.A,{onUploaded:e=>{if("approved"===e.status&&e.url){const t=e.url.startsWith("/")?r.A.defaults.baseURL.replace(/\/$/,"")+e.url:e.url;y(t)}}}),x&&(0,i.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:6},children:[(0,i.jsx)("img",{src:x,alt:"preview",style:{width:64,height:64,objectFit:"cover",borderRadius:6,flexShrink:0}}),(0,i.jsx)("button",{type:"button",onClick:()=>y(""),children:"Retirer"})]}),(0,i.jsx)("button",{type:"submit",children:"Envoyer"})]})]})]})]})}},912:(e,t,l)=>{l.d(t,{A:()=>s});var n=l(555),r=l(43),a=l(674),i=l(579);function s(e){let{onUploaded:t,showPreview:l=!0,previewSize:s=64}=e;const[o,d]=(0,r.useState)(null),[c,u]=(0,r.useState)(""),[p,h]=(0,r.useState)(""),v=(0,r.useRef)(null);return(0,i.jsxs)("div",{style:{display:"flex",flexDirection:"column",gap:8},children:[(0,i.jsx)("input",{type:"file",accept:"image/png,image/jpeg,image/webp",ref:v,onChange:e=>{var t;const l=null===(t=e.target.files)||void 0===t?void 0:t[0];l&&(l.size>2097152?u("> 2MB refus\xe9"):(d(l),h(URL.createObjectURL(l)),u("")))}}),l&&p&&(0,i.jsx)("img",{src:p,alt:"pr\xe9visualisation",style:{width:s,height:s,objectFit:"cover",border:"1px solid var(--line)",borderRadius:6}}),(0,i.jsx)("button",{className:"week-btn",type:"button",onClick:async e=>{var l;if(null===e||void 0===e||null===(l=e.preventDefault)||void 0===l||l.call(e),!o)return;u("Envoi...");const r=new FormData;r.append("file",o);try{var i,s;const{data:e}=await a.A.post("/media/image",r,{headers:{"Content-Type":"multipart/form-data"}});u("approved"===e.status?"OK":"En attente mod\xe9ration"),d(null),v.current&&(v.current.value="");const l=(null===a.A||void 0===a.A||null===(i=a.A.defaults)||void 0===i||null===(s=i.baseURL)||void 0===s?void 0:s.replace(/\/$/,""))||"",o=null!==e&&void 0!==e&&e.url?e.url.startsWith("/")?l+e.url:e.url:"";h("approved"===e.status&&o?o:""),t&&t((0,n.A)((0,n.A)({},e),{},{absoluteUrl:o}))}catch(g){var c,p;const e=(null===(c=g.response)||void 0===c||null===(p=c.data)||void 0===p?void 0:p.error)||"Erreur upload";u(e)}},disabled:!o,children:"Uploader l\u2019image"}),c&&(0,i.jsx)("small",{style:{color:"var(--muted)"},children:c})]})}}}]);
//# sourceMappingURL=519.718138aa.chunk.js.map